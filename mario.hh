static unsigned MarioTimer = 0;

static const char Mario[] =
//     0123456789ABCDEF        0123456789ABCDEF        0123456789ABCDEF
//12345""""""""""""""""012345________________012345________________012345
/*
"??????      #####     ??????                ??????      #####     ??????"
"??????     #########  ??????       #####    ??????     #########  ??????"
"??????     %%%''%'    ??????      ######### ??????     %%%''%'    ??????"
"??????    %'%'''%'''  ??????      %%%''%'   ??????    %'%'''%'''  ??????"
"??????    %'%%'''%''' ??????     %'%'''%''' ??????    %'%%'''%''' ??????"
"??????    %%''''%%%%  ??????     %'%%'''%'' ??????    %%''''%%%%  ??????"
"??????      '''''''   ??????     %%''''%%%% ??????      '''''''   ??????"
"??????     %%#%%%     ??????       '''''''  ??????   %%%%##%%     ??????"
"??????    %%%%##%%    ??????      %%%%#% '  ?????? ''%%%%###%%%'''??????"
"??????    %%%##'##'   ??????     '%%%%%%''' ?????? ''' %%#'###%%''??????"
"??????    %%%%#####   ??????    ''#%%%%%''  ?????? ''  #######  % ??????"
"??????    #%%'''###   ??????    %%#######   ??????    #########%% ??????"
"??????     #%''###    ??????    %########   ??????   ##########%% ??????"
"??????      ###%%%    ??????   %%### ###    ??????  %%###   ###%% ??????"
"??????      %%%%%%%   ??????   %    %%%     ??????  %%%           ??????"
"??????      %%%%      ??????        %%%%    ??????   %%%          ??????"*/

//.......0123456789ABCDEF      ..0123456789ABCDEF  
//1234567""""""""""""""""01234567""""""""""""""""01234567
"????????                ????????      #####     ????????"
"????????      ######    ????????     #'''''###  ????????"
"????????     #''''''##  ????????    #'''''''''# ????????"
"????????    #'''''''''# ????????    ###'.#.###  ????????"
"????????    ###..#.###  ????????   #..##.#....# ????????"
"????????   #..##.#....# ????????   #..##..#...# ????????"
"????????   #..##..#...# ????????    ##...#####  ????????"
"????????    ##...#####  ????????    ###.....#   ????????"
"????????     ##.....#   ????????  ##'''##''###  ????????"
"????????    #''##''#    ???????? #..''''##''#'# ????????"
"????????   #''''##''#   ???????? #..'''######'.#????????"
"????????   #''''#####   ????????  #..####.##.#.#????????"
"????????    #...##.##   ????????  .#########''# ????????"
"????????    #..'''###   ????????  #''######'''# ????????"
"????????     #'''''#    ????????  #'''#  #'''#  ????????"
"????????      #####     ????????   ###    ###   ????????"
"??";

static const char Mario21[] =
"??????                ??????       #####    ??????"
"??????       #####    ??????     ##'''Y'#   ??????"
"??????     ##'''Y'#   ??????    #''++YYY#   ??????"
"??????    #''++YYY#   ??????   #+'++######  ??????"
"??????   #+'++######  ??????  #+++######### ??????"
"??????  #+++######### ??????  #.###:#:#:    ??????"
"??????  #.###:#:#:    ?????? #.#.#:.#.#.##  ??????"
"?????? #.#.#:.#.#.##  ?????? #:#.##.......# ??????"
"?????? #:#.##.......# ?????? ##:.#..#:::::# ??????"
"?????? ##:.#..#:::::# ??????  ##::.#######  ??????"
"??????  ##::.#######  ??????   ##::::####   ??????"
"??????   ###:::####   ??????   #+#####%     ??????"
"??????    #+####%     ??????   #++'#,11%    ??????"
"??????   #++',,11%    ??????  ##...#..1.%## ??????"
"??????   ####,..1.%   ?????? ###..#,..1.#Y##??????"
"??????   #...#..1.%   ?????? ###..#,,,1%####??????"
"??????   #..#,,,11%   ?????? ##%##,,,,%#### ??????"
"??????   #..#,,%,%    ?????? ##Y# %%%% #### ??????"
"??????    #######     ??????  ##        ##  ??????"
"??????    ####Y#Y#    ??????                ??????"
"??????    ########    ??????                ??????";
static const char Mario32[] =
//"""""""0123456789ABCDEF0123456789ABCDEFGH""""""""0123456789ABCDEF0123456789ABCDEFGH""""""""0123456789ABCDEF0123456789ABCDEFGH""""""""
"????????                                  ????????                                  ????????                                  ????????"
"????????                                  ????????                                  ????????                                  ????????"
"????????                                  ????????                                  ????????                                  ????????"
"????????           ##   ##                ????????           ##   ##                ????????           ##   ##                ????????"
"????????           #.######               ????????           #.######               ????????           #.######               ????????"
"????????           #..#,,,,#              ????????           #..#,,,,#              ????????           #..#,,,,#              ????????"
"????????          #,..,,,,,#              ????????          #,..,,,,,#              ????????          #,..,,,,,#              ????????"
"????????         #,,.,,,,,,,#             ????????         #,,.,,,,,,,#             ????????         #,,.,,,,,,,#             ????????"
"????????         #,,,,,,,,,,#             ????????         #,,,,,,,,,,#             ????????         #,,,,,,,,,,#             ????????"
"????????        #,,,,,,,,,,,#             ????????        #,,,,,,,,,,,#             ????????        #,,,,,,,,,,,#             ????????"
"????????        #,,,,,,####,#             ????????        #,,,,,,####,#             ????????        #,,,,,,####,#             ????????"
"????????        #,,,,,#..#.#              ????????        #,,,,,#..#.#              ????????        #,,,,,#..#.#              ????????"
"????????        #,,,,,...#.###            ????????        #,,,,,...#.###            ????????        #,,,,,...#.###            ????????"
"????????        #,,,,,........#######     ????????        #,,,,,........#######     ????????        #,,,,,........#######     ????????"
"????????         #,,,,..#.....##....##    ????????         #,,,,..#.....##....##    ????????         #,,,,..#.....##....##    ????????"
"????????         #,,,,.###...##.......#   ????????         #,,,,.###...##.......#   ????????         #,,,,.###...##.......#   ????????"
"????????          ##,,...#####.######..## ????????          ##,,...#####.######..## ????????          ##,,...#####.######..## ????????"
"????????           ####....#..#,,,,,,#...#????????           ####....#..#,,,,,,#...#????????           ####....#..#,,,,,,#...#????????"
"????????          #,#,,####.###,,,,,,###..????????          #,#,,####.###,,,,,,###..????????          #,#,,####.###,,,,,,###..????????"
"????????          ##,,,,,####,,#,,,,#,,###????????          ##,,,,,####,,#,,,,#,,###????????          ##,,,,,####,,#,,,,#,,###????????"
"????????         #,#,,,,,,,##,,,####,,,,,#????????         #,#,,,,,,,##,,,####,,,,,#????????         #,#,,,,,,,##,,,####,,,,,#????????"
"????????         #,,#,,,,,#..#,#,,,,#,,,##????????         #,,#,,,,,#..#,#,,,,#,,,##????????         #,,#,,,,,#..#,#,,,,#,,,##????????"
"????????       ###,,,##,,#....#,,,,,,#,## ????????    ######,,,##,,#....#,,,,,,#,## ???????? #########,,,##,,#....#,,,,,,#,## ????????"
"????????     ##..#,,,,,###....#,,,,,,,#,# ????????  ###,,..#,,,,,###....#,,,,,,,#,# ????????##,..,,...#,,,,###....#,,,,,,,#,# ????????"
"????????    #.,..#,,,,,,,##..##,,,,,,#,#  ???????? ##..,,..#,,,,,,,##..##,,,,,,#,#  ????????#,,..,,...#,,,,,,##..##,,,,,,#,#  ????????"
"????????   #...,.#,,,,,,,..##,,#,,,,#,,#  ???????? #,,..,,#,,,,,,,,..##,,#,,,,#,,#  ????????#,,..,,..#,,,,,,,,.##.##,,,,#,,#  ????????"
"????????  #,,..,# #,,,,,,,..##,,####,,#   ???????? #,,..,,#,,,,,,,,,..,#,,####,,#   ????????##,..,,##..,,,,,,,,...#,####,,#   ????????"
"????????  #,,..#  #,,,,,,,,,# ##,,,,##    ???????? ##,,###,,,,,,,#,,,,,.##,,,,##    ???????? #######..,,,,,###,...##,,,,##    ????????"
"????????  #,,,#    #,,,,,,##   ######     ????????  ###   #.,,,,# #,,,..#######     ????????       #..,,###   #..########     ????????"
"????????  ##,,#    #,,,,,#                ????????        #..,,#   #,..#            ????????       #..##       ###            ????????"
"????????   ###     #......#               ????????         #....#  #..#             ????????        ##                        ????????"
"????????           ########               ????????          ####    ##              ????????                                  ????????"
;

// Return value: 0 or 1=keep old, 2=set to zero, 3=set to one
static unsigned char GetMarioBit(
    unsigned pose,          // frame number
    unsigned x, unsigned y, // coordinates for dithering 
    signed int MarioOffset, // -6..+16
    unsigned VidCellHeight = 16)
{
    const unsigned NumMarioPoses = VidCellHeight >= 29 ? 3 : 2;

    const char* data =
        VidCellHeight <= 16
      ?    (Mario + 8 + pose * unsigned(16+8)
          + y * unsigned(8*(NumMarioPoses+1)+16*NumMarioPoses)
          + MarioOffset)
      : VidCellHeight <= 20
      ?    (Mario21 + 6 + pose * unsigned(16+6)
          + y * unsigned(6*(NumMarioPoses+1)+16*NumMarioPoses)
          + MarioOffset)
      :    (Mario32 + 8 + pose * unsigned(34+8)
          + y * unsigned(8*(NumMarioPoses+1)+34*NumMarioPoses)
          + MarioOffset);

    static const unsigned char dither4x4[16] =
        {0,12,3,15, 8,4,11,7, 2,14,1,13, 10,6,9,5};
    const unsigned char* dithline = dither4x4 + (((y+MarioTimer) & 3u) * 4u);

    unsigned char dithval = dithline[ x&3 ];
    switch(*data++ / 3)
    {
        case '.' / 3: // 15
            return 2;                  // 0%
        case 'Y' / 3: // 29
            return 2 + (dithval < 2);  // 12.5%
        case ':' / 3: // 19
            return 2 + (dithval < 4);  // 25%
        case ',' / 3: // 14
        case '\'' / 3: // 13
            return 2 + (dithval >> 3); // 50%
        case '%' / 3: // 12
            return 2 + (dithval >= 4); // 75%
        case '#' / 3: // 11
            return 3;                  // 100%
        default:
        case '?' / 3: // 21
        case ' ' / 3: // 10
            // transparent, no change
            return 0;
    }
}
